# assumes install_command is set
---
- name: Translate target names
  ansible.builtin.set_fact:
    target_names: "{{ target_names + [target_name_map[item]] }}"
  loop: "{{ targets }}"
  vars:
    target_names: []

- name: Add infrastructure if logs is in targets
  ansible.builtin.set_fact:
    target_names: "{{ target_names + [target_name_map['infrastructure']] }}"
  when: "target_name_map['logs'] in target_names and target_name_map['infrastructure'] is not in target_names"

- name: Assert if PHP is targeted for Windows
  when: php_targeted and os_name == 'windows'
  ansible.builtin.debug:
    msg: "APM for PHP on Windows is not supported; removing it from 'targets'..."

- name: Remove APM PHP from targets if on Windows
  ansible.builtin.set_fact:
    target_names: "{{ target_names | difference([target_name_map['apm-php']]) }}"
  when:
    - os_name == 'windows'
    - php_targeted
    - target_names | length > 0  # Fail if 'apm-php' was the only target and was removed.

- name: Attach install targets
  ansible.builtin.set_fact:
    install_command: "{{ install_command }} -n {{ target_names | join(',') }}"

- name: Attach optional verbosity
  when: verbosity is defined
  ansible.builtin.set_fact:
    install_command: "{{ install_command }} --{{ verbosity }}"

- name: Build default CLI tags
  ansible.builtin.set_fact:
    cli_tags:
      nr_deployed_by: ansible-install

- name: Add optional CLI tags
  when: tags is defined
  ansible.builtin.set_fact:
    cli_tags: "{{ cli_tags | combine(tags) }}"

- name: Attach tags
  ansible.builtin.set_fact:
    install_command: "{{ install_command }} --tag {{ cli_tags.keys() | zip(cli_tags.values()) | map('join', ':') | join(',') }} "

- name: Create install command report
  ansible.builtin.set_fact:
    install_command_report: r"{{ install_command | regex_replace('(?<=NEW_RELIC_API_KEY=)[^\s]*', '<hidden>') }}"

- name: Report install command
  ansible.builtin.debug:
    msg: "{{ install_command_report }}"
